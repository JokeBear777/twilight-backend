<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <title>í™ˆí™”ë©´</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>
        @font-face {
            font-family: 'CookieRun-Regular';
            src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_2001@1.1/CookieRun-Regular.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }

        body {
            font-family: 'CookieRun-Regular', sans-serif;
            background: #e6dcd0;
            min-height: 100vh;
            margin: 0;
        }

        .card-main-container {
            width: 375px;
            height: 650px;
            background-color: #fffaf6;
            border-radius: 1.5rem;
            display: flex;
            flex-direction: column;
            margin: 2rem auto;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            border: 2px solid #d6ccc2;
            /* âœ… 100vw ë°‘ì¤„ì´ ì˜ë¦¬ì§€ ì•Šë„ë¡ */
            overflow: visible;
        }

        .card-header {
            padding: 1.25rem 1.5rem 0.2rem 1.5rem;
            background-color: transparent;
            font-size: 1.2rem;
            font-weight: bold;
            color: #5e4633;
        }

        /* âœ… ìœ„â†’ì•„ë˜ë¡œ ìŒ“ì´ê³ , ê°€ë¡œëŠ” ê½‰ ì±„ì›€ */
        .card-body-center {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            /* ìœ„ì—ì„œë¶€í„° */
            align-items: stretch;
            /* ê°€ë¡œ ê½‰ ì±„ìš°ê¸° */
            padding: 0;
            /* ë¦¬ìŠ¤íŠ¸ê°€ ìì²´ íŒ¨ë”© ê°–ë„ë¡ 0 */
            text-align: left;
            min-height: 0;
        }

        .free-board-post-list {
            display: flex;
            flex-direction: column;
            gap: 0;
            /* ë°‘ì¤„ë¡œ êµ¬ë¶„í•˜ë‹ˆ ê°„ê²©ì€ 0 */
        }

        /* â¬‡ ê°œë³„ ê²Œì‹œê¸€ ì¤„ */
        .notice-item {
            position: relative;
            /* ::after ê¸°ì¤€ */
            display: flex;
            flex-direction: column;
            padding: 0.8rem 1rem;
            /* ì¢Œìš° íŒ¨ë”©ì€ ì¹´ë“œ ì•ˆìª½ ì—¬ë°± */
            background: #fffaf6;
            /* ì¹´ë“œ ë°°ê²½ê³¼ ë™ì¼ */
        }

        /* âœ… ìŠ¤ë§ˆíŠ¸í° í™”ë©´ ì „ì²´í­ ë°‘ì¤„ */
        .notice-item::after {
            content: "";
            position: absolute;
            left: 0;
            bottom: 0;
            width: 100%; /* âœ… ì¹´ë“œ ì•ˆìª½ í­ë§Œ ì‚¬ìš© */
            border-bottom: 1px solid rgba(0, 0, 0, 0.15);
            pointer-events: none;
            z-index: 1;
        }

        .notice-item:last-child::after {
            border-bottom: none;
        }

        /* ì²« ì¤„: [ëŒ“ê¸€ìˆ˜] ì œëª© */
        .post-top {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .comment-count {
            font-weight: bold;
            color: #8b5e34;
        }

        .post-title {
            flex: 1;
            /* ë‚¨ëŠ” ê³µê°„ ì°¨ì§€ */
            min-width: 0;
            /* ë§ì¤„ì„ ì²˜ë¦¬ë¥¼ ìœ„í•´ */
            display: block;
            /* flex itemì´ë¼ ê°™ì€ ì¤„ ìœ ì§€ */
            color: #3e2f20;
            text-decoration: none;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .post-title:hover {
            text-decoration: underline;
        }

        /* ë‘ ë²ˆì§¸ ì¤„: ì‹œê°„ | ì‘ì„±ì | ì¡°íšŒ | ì¶”ì²œ */
        .post-bottom {
            font-size: 0.8rem;
            color: #8a7a6a;
            margin-left: 1.6rem;
            /* ëŒ“ê¸€ìˆ˜ ì˜ì—­ë§Œí¼ ì‚´ì§ ë“¤ì—¬ì“°ê¸° */
        }

        .separator {
            margin: 0 0.3rem;
            color: #c2b6a3;
        }

        .footer-nav {
            background-color: #ead4c5;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom-left-radius: 1.5rem;
            border-bottom-right-radius: 1.5rem;
        }

        .footer-nav .btn-dark {
            background: transparent;
            border: none;
            color: #4e3b31;
            flex: 1;
        }

        .footer-nav .btn-dark.active {
            color: #c45b5b;
        }

        .footer-nav .btn-dark i {
            font-size: 1.2rem;
            margin-bottom: 0.25rem;
        }

        .footer-nav .btn-dark small {
            font-size: 0.75rem;
        }

        .scroll-area {
            flex: 1 1 auto;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            /* iOS ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ */
            padding-bottom: .5rem;
            /* footerì™€ ê°„ê²© */
        }
    </style>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const postList = document.getElementById("post-list");
            const sentinel = document.getElementById("scroll-sentinel");
            const scrollRoot = document.querySelector(".scroll-area");

            console.log("[init] postList:", !!postList, "sentinel:", !!sentinel, "scrollRoot:", !!scrollRoot);

            if (!postList) return;

            // ê²Œì‹œê¸€ ì—†ì„ ë•Œ ë©”ì‹œì§€
            const posts = postList.querySelectorAll(".notice-item");
            if (posts.length === 0) {
                const emptyMessage = document.createElement("p");
                emptyMessage.textContent = "ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.";
                emptyMessage.style.textAlign = "center";
                emptyMessage.style.color = "#777";
                emptyMessage.style.margin = "2rem 0";
                postList.prepend(emptyMessage);
            }

            if (!sentinel) {
                console.error("[init] #scroll-sentinel ì´ DOMì— ì—†ìŠµë‹ˆë‹¤. post-list ë‚´ë¶€ ë§¨ ì•„ë˜ì— ì¶”ê°€í•˜ì„¸ìš”.");
                return;
            }

            let isLoading = false;
            let hasNext = true;
            let lastId = null;// cursor.lastId
            let lastCreatedAt = null;
            const pageSize = 10;

            async function loadMorePosts() {
                if (isLoading || !hasNext) return;
                isLoading = true;

                let url = `/api/v1/bulletin/free-board?pageSize=10`;
                if (lastId !== null && lastCreatedAt !== null) {
                    url += `&lastId=${lastId}`;
                    url += `&lastCreatedAt=${encodeURIComponent(lastCreatedAt)}`;
                }

                console.log("[fetch]", url);

                try {
                    const res = await fetch(url, {
                        headers: { "Accept": "application/json" }
                    });
                    if (!res.ok) throw new Error("ìš”ì²­ ì‹¤íŒ¨: " + res.status);

                    const result = await res.json();

                    result.data.forEach(post => {
                        postList.insertBefore(createPostElement(post), sentinel);
                    });

                    hasNext = result.hasNext;
                    lastId = result.nextCursor ? result.nextCursor.lastId : null;
                    lastCreatedAt = result.nextCursor?.lastCreatedAt ?? null;

                    if (!hasNext) observer.disconnect();
                } catch (e) {
                    console.error(e);
                } finally {
                    isLoading = false;
                }
            }

            function createPostElement(post) {
                const item = document.createElement("div");
                item.className = "notice-item";
                item.innerHTML = `
      <div class="post-top">
        <span class="comment-count">${post.numberOfComments ?? 0}</span>
        <a class="post-title" href="/bulletin/free-board/${post.freeBoardPostId}">
          ${escapeHtml(post.title ?? "")}
        </a>
      </div>
      <div class="post-bottom">
        <span>${formatDate(post.createdAt)}</span>
        <span class="separator">|</span>
        <span>${escapeHtml(post.name ?? "")}</span>
        <span class="separator">|</span>
        <span>ì¡°íšŒ ${post.views ?? 0}</span>
        <span class="separator">|</span>
        <span>ì¶”ì²œ ${post.numberOfRecommendations ?? 0}</span>
      </div>
    `;
                return item;
            }

            function formatDate(isoString) {
                if (!isoString) return "";
                const date = new Date(isoString);
                if (isNaN(date.getTime())) return String(isoString); // ì—­ì§ë ¬í™” í¬ë§· ì´ìƒí•  ë•Œ ëŒ€ë¹„
                return date.toLocaleString("ko-KR", {
                    year: "numeric", month: "2-digit", day: "2-digit",
                    hour: "2-digit", minute: "2-digit"
                });
            }

            function escapeHtml(str) {
                return String(str)
                    .replaceAll("&", "&amp;")
                    .replaceAll("<", "&lt;")
                    .replaceAll(">", "&gt;")
                    .replaceAll('"', "&quot;")
                    .replaceAll("'", "&#039;");
            }

            // rootëŠ” scroll-area (ë„ˆ ì½”ë“œì²˜ëŸ¼)
            const observer = new IntersectionObserver((entries) => {
                if (entries[0].isIntersecting) {
                    console.log("[observer] intersect");
                    loadMorePosts();
                }
            }, {
                root: scrollRoot,     // scroll-areaì—ì„œ ìŠ¤í¬ë¡¤ë˜ë¯€ë¡œ ì—¬ê¸°ë¡œ ì§€ì •
                rootMargin: "200px",  // ë°”ë‹¥ ë‹¿ê¸° ì „ì— ë¯¸ë¦¬ ë¡œë”©
                threshold: 0.01
            });

            observer.observe(sentinel);

            // ì´ˆê¸°ì—ë„ í•œ ë²ˆ ì±„ì›Œì£¼ê¸° (ìŠ¤í¬ë¡¤ì´ ì¶©ë¶„íˆ ì•ˆ ìƒê¸°ë©´ observerê°€ ë°”ë¡œ ì•ˆ ë¶ˆë¦´ ìˆ˜ ìˆìŒ)
            loadMorePosts();
        });
    </script>
</head>

<body>
<section class="d-flex justify-content-center align-items-center" style="min-height: 100vh;">
    <div class="card-main-container">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>ğŸ“Œ ììœ ê²Œì‹œíŒ</span>

            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-secondary d-flex align-items-center"
                        style="padding: 0.25rem 0.6rem; font-size: 0.8rem;">
                    <i class="fas fa-search mr-1"></i>ê²€ìƒ‰
                </button>

                <button class="btn btn-sm btn-outline-secondary d-flex align-items-center"
                        style="padding: 0.25rem 0.6rem; font-size: 0.8rem;"
                        onclick="location.href='/bulletin/free-board/write'">
                    <i class="fas fa-pen mr-1"></i>ê¸€ì“°ê¸°
                </button>
            </div>
        </div>


        <div class="card-body-center">
            <div class="scroll-area">

                <!-- âœ… í…ŒìŠ¤íŠ¸ìš© ë”ë¯¸ ë°ì´í„° (ë°°í¬ ì‹œ ì œê±°) -->
                <div class="free-board-post-list" id="post-list">

                    <!--
                 th:with="freeBoardPostList=${[
       {'id':1,'title':'ì²« ê¸€ì…ë‹ˆë‹¤','commentCount':12,'timeAgo':'3ë¶„ ì „','writer':'ë¯¼ìš°','viewCount':123,'likeCount':7},
       {'id':2,'title':'ë‘ ë²ˆì§¸ í…ŒìŠ¤íŠ¸ ê¸€','commentCount':3,'timeAgo':'7ë¶„ ì „','writer':'í™ê¸¸ë™','viewCount':45,'likeCount':2},
       {'id':3,'title':'ì„¸ ë²ˆì§¸ ê¸€ì…ë‹ˆë‹¤ ì œëª©ì´ ê¸¸ë©´ ì´ë ‡ê²Œ ê¸¸ì–´ì ¸ë„ ë§ì¤„ì„ìœ¼ë¡œ ê¹”ë”í•˜ê²Œ ì²˜ë¦¬ë©ë‹ˆë‹¤','commentCount':0,'timeAgo':'12ë¶„ ì „','writer':'Alice','viewCount':9,'likeCount':0},
       {'id':4,'title':'ë„¤ ë²ˆì§¸ ê¸€ - ëª¨ë°”ì¼ì—ì„  ë°‘ì¤„ì´ í™”ë©´ ëê¹Œì§€!','commentCount':8,'timeAgo':'20ë¶„ ì „','writer':'Bob','viewCount':88,'likeCount':10}
     ]}">
    -->
                    <div th:each="post : ${postList}" class="notice-item">
                        <!-- ì²« ì¤„: ëŒ“ê¸€ ìˆ˜ | ì œëª© -->
                        <div class="post-top">
                            <span class="comment-count" th:text="${post.numberOfComments}">12</span>
                            <a class="post-title" th:href="@{/bulletin/free-board/{id}(id=${post.freeBoardPostId})}"
                               th:text="${post.title}">[TEST] ì œëª©ì…ë‹ˆë‹¤. 1</a>
                        </div>

                        <!-- ë‘ ë²ˆì§¸ ì¤„: | xë¶„ì „ | ê¸€ì“´ì´ | ì¡°íšŒ | ì¶”ì²œ -->
                        <div class="post-bottom">
                        <span class="post-time"
                              th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}">2022-03-12 12:23</span>
                            <span class="separator">|</span>
                            <span class="post-writer" th:text="${post.name}">ì‘ì„±ì</span>
                            <span class="separator">|</span>
                            <span class="post-view" th:text="'ì¡°íšŒ ' + ${post.views}">ì¡°íšŒ 12</span>
                            <span class="separator">|</span>
                            <span class="post-like" th:text="'ì¶”ì²œ ' + ${post.numberOfRecommendations}">ì¶”ì²œ 5</span>
                        </div>
                    </div>

                    <!-- ë¬´í•œ ìŠ¤í¬ë¡¤ ê°ì§€ìš© -->
                    <div id="scroll-sentinel" style="height: 1px;"></div>
                </div>

            </div>
        </div>

        <nav class="footer-nav d-flex justify-content-around text-white">
            <button class="btn btn-dark d-flex flex-column align-items-center" onclick="location.href='/home'">
                <i class="fas fa-home"></i><small>í™ˆ</small>
            </button>
            <button class="btn btn-dark d-flex flex-column align-items-center" onclick="location.href='/record'">
                <i class="fas fa-book"></i><small>ë‚´ ì„œì¬</small>
            </button>
            <button class="btn btn-dark d-flex flex-column align-items-center"
                    onclick="location.href='/book/recommendation'">
                <i class="fas fa-search"></i><small>ì±… ì¶”ì²œ</small>
            </button>
            <button class="btn btn-dark d-flex flex-column align-items-center active"
                    onclick="location.href='/bulletin'">
                <i class="fas fa-comments"></i><small>ê²Œì‹œíŒ</small>
            </button>
            <button class="btn btn-dark d-flex flex-column align-items-center" onclick="location.href='/mypage'">
                <i class="fas fa-user"></i><small>ë‚´ ì •ë³´</small>
            </button>
        </nav>
    </div>
</section>
</body>

</html>
